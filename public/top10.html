<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 10 Box Office ‚Äî CineVerse Analytics</title>
    <meta name="description" content="Discover the top 10 highest grossing movies of all time. Compare box office earnings across Hollywood, Bollywood, and Tollywood.">
    <meta name="keywords" content="top 10 movies, highest grossing films, box office records, top movies, best performing films">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cineverse.com/top10.html">
    <meta property="og:title" content="Top 10 Box Office ‚Äî CineVerse Analytics">
    <meta property="og:description" content="Discover the top 10 highest grossing movies of all time. Compare box office earnings across Hollywood, Bollywood, and Tollywood.">
    <meta property="og:image" content="https://cineverse.com/images/og-image.jpg">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Top 10 Box Office ‚Äî CineVerse Analytics">
    <meta name="twitter:description" content="Discover the top 10 highest grossing movies of all time. Compare box office earnings across Hollywood, Bollywood, and Tollywood.">
    <meta name="twitter:image" content="https://cineverse.com/images/og-image.jpg">
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé¨</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="animated-bg"></div>
    <div class="scroll-progress" id="scroll-progress"></div>
    
    <nav class="navbar">
        <div class="logo">üé¨ CineVerse</div>
        <ul class="nav-links">
            <li><a href="index.html">üé¨ Home</a></li>
            <li><a href="movies.html">üéûÔ∏è All Movies</a></li>
            <li><a href="hollywood.html">üåç Hollywood</a></li>
            <li><a href="bollywood.html">üé• Bollywood</a></li>
            <li><a href="tollywood.html">üé≠ Tollywood</a></li>
            <li><a href="top10.html">üèÖ Top 10</a></li>
            <li><a href="analytics.html">üìä Analytics</a></li>
            <li><a href="compare.html">‚öñÔ∏è Compare</a></li>
            <li><a href="about.html">‚ÑπÔ∏è About</a></li>
            <li><a href="contact.html">üíå Contact</a></li>
        </ul>
        <button class="theme-toggle" id="theme-toggle">üåô</button>
    </nav>

    <section style="padding: 4rem 2rem;">
        <h1 style="text-align: center; font-family: 'Orbitron', sans-serif; font-size: 3.5rem; margin-bottom: 3rem; color: var(--text);">
            üèÖ Top 10 Worldwide Box Office
        </h1>

        <div style="text-align: center; margin-bottom: 2rem;">
            <div class="currency-toggle" style="display: inline-flex;">
                <button class="currency-btn active" data-currency="INR">‚Çπ INR</button>
                <button class="currency-btn" data-currency="USD">$ USD</button>
            </div>
        </div>

        <div class="leaderboard" id="leaderboard">
            <!-- Top 10 movies will be loaded here -->
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h2 class="chart-title">üìä Top 10 Earnings Comparison</h2>
                <div style="position: relative; height: 400px; width: 100%;">
                    <canvas id="top10Chart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2 class="chart-title">üìà Earnings by Category</h2>
                <div style="position: relative; height: 400px; width: 100%;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="footer-content">
            <p style="font-size: 0.75rem; line-height: 1.5; margin: 0;">Your Ultimate Box Office Analytics Platform | ¬© 2025 CineVerse Analytics | Developed by Mohammad Aakib Bhat</p>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        let top10Movies = [];
        let currentCurrency = 'INR';
        let top10ChartInstance = null;
        let categoryChartInstance = null;

        async function loadTop10() {
            console.log('loadTop10() called');
            const leaderboard = document.getElementById('leaderboard');
            const top10ChartEl = document.getElementById('top10Chart');
            const categoryChartEl = document.getElementById('categoryChart');
            
            // Show loading state
            if (leaderboard) {
                leaderboard.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--text-secondary);">Loading top 10 movies...</div>';
            }
            
            try {
                console.log('Fetching top 10 movies...');
                top10Movies = await fetchTop10();
                console.log('Top 10 movies received:', top10Movies.length);
                
                if (!top10Movies || top10Movies.length === 0) {
                    if (leaderboard) {
                        leaderboard.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--text-secondary);">No movies found. Please check if the server is running.</div>';
                    }
                    return;
                }
                
                currentCurrency = getCurrency();
                displayLeaderboard();
                
                // Wait for DOM to be ready and ensure charts container is visible
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        loadTop10Chart();
                        loadCategoryChart();
                    }, 300);
                });
                
                console.log('Top 10 page loaded successfully');
            } catch (error) {
                console.error('Error loading top 10:', error);
                if (leaderboard) {
                    leaderboard.innerHTML = `
                        <div style="text-align: center; padding: 4rem; color: var(--text-secondary);">
                            <p>Error loading movies. Please check console for details.</p>
                            <button class="btn btn-primary" onclick="loadTop10()" style="margin-top: 1rem;">Retry</button>
                        </div>
                    `;
                }
            }
        }

        function displayLeaderboard() {
            const container = document.getElementById('leaderboard');
            if (!container) {
                console.error('Leaderboard container not found!');
                return;
            }

            if (!top10Movies || top10Movies.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 4rem; color: var(--text-secondary);">No movies to display.</div>';
                return;
            }

            console.log('Displaying leaderboard with', top10Movies.length, 'movies');
            container.innerHTML = top10Movies.map((movie, index) => {
                const rank = index + 1;
                let medal = '';
                if (rank === 1) medal = 'ü•á';
                else if (rank === 2) medal = 'ü•à';
                else if (rank === 3) medal = 'ü•â';
                
                const gross = getGrossAmount(movie, currentCurrency);
                const formattedGross = formatCurrency(gross, currentCurrency);
                
                return `
                    <div class="leaderboard-item" onclick="window.location.href='movie.html?id=${movie.id}'">
                        <div class="rank ${rank <= 3 ? `rank-${rank}` : ''}">
                            ${medal} ${rank}
                        </div>
                        <img src="${getPosterURL(movie)}" alt="${movie.title}" class="leaderboard-poster" onerror="this.src='https://via.placeholder.com/100x150?text=No+Poster'">
                        <div class="leaderboard-info">
                            <h3 class="leaderboard-title">${movie.title}</h3>
                            <div class="leaderboard-year">${movie.year} ‚Ä¢ ${movie.category}</div>
                            <div class="leaderboard-gross">${formattedGross}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadTop10Chart() {
            const chartEl = document.getElementById('top10Chart');
            if (!chartEl) {
                console.error('Top 10 chart element not found!');
                return;
            }
            
            if (!top10Movies || top10Movies.length === 0) {
                console.warn('No movies data for chart');
                chartEl.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No data available for chart</p>';
                return;
            }
            
            // Ensure container is visible and has dimensions
            const chartContainer = chartEl.parentElement;
            if (chartContainer) {
                chartContainer.style.display = 'block';
                chartContainer.style.position = 'relative';
                chartContainer.style.height = '400px';
                chartContainer.style.width = '100%';
            }
            
            // Ensure canvas has proper dimensions
            chartEl.style.width = '100%';
            chartEl.style.height = '100%';
            
            // Force layout recalculation
            void chartEl.offsetHeight;
            
            // Destroy existing chart if it exists
            if (top10ChartInstance) {
                top10ChartInstance.destroy();
                top10ChartInstance = null;
            }
            
            // Wait for layout to complete and Chart.js to be ready
            requestAnimationFrame(() => {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not available');
                    chartEl.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Chart.js library not loaded</p>';
                    return;
                }
                
                const ctx = chartEl.getContext('2d');
                if (!ctx) {
                    console.error('Could not get canvas context');
                    return;
                }
                
                const labels = top10Movies.map(m => m.title.length > 20 ? m.title.substring(0, 20) + '...' : m.title);
                const data = top10Movies.map(m => getGrossAmount(m, currentCurrency));
                
                console.log('Creating top 10 chart with', labels.length, 'movies');
                console.log('Chart data:', data);
                console.log('Canvas dimensions:', chartEl.offsetWidth, chartEl.offsetHeight);
                
                try {
                    top10ChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Worldwide Gross (${currentCurrency})`,
                            data: data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: 'var(--text)',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        if (currentCurrency === 'USD') {
                                            return '$' + formatNumber(value);
                                        }
                                        return '‚Çπ' + formatNumber(value);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text)',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        if (currentCurrency === 'USD') {
                                            return '$' + (value / 1000000000).toFixed(1) + 'B';
                                        }
                                        return '‚Çπ' + (value / 10000000000).toFixed(1) + 'Cr';
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'var(--text)',
                                    font: {
                                        size: 10
                                    },
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                    });
                    console.log('Top 10 chart created successfully');
                } catch (error) {
                    console.error('Error creating top 10 chart:', error);
                    chartEl.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Error loading chart: ' + error.message + '</p>';
                }
            });
        }
        
        function formatNumber(num) {
            if (num >= 1000000000000) {
                return (num / 1000000000000).toFixed(2) + 'T';
            } else if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            } else if (num >= 10000000) {
                return (num / 10000000).toFixed(2) + 'Cr';
            } else if (num >= 100000) {
                return (num / 100000).toFixed(2) + 'L';
            }
            return num.toLocaleString();
        }

        function loadCategoryChart() {
            const chartEl = document.getElementById('categoryChart');
            if (!chartEl) {
                console.error('Category chart element not found!');
                return;
            }
            
            if (!top10Movies || top10Movies.length === 0) {
                console.warn('No movies data for category chart');
                chartEl.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No data available for chart</p>';
                return;
            }
            
            // Ensure container is visible and has dimensions
            const chartContainer = chartEl.parentElement;
            if (chartContainer) {
                chartContainer.style.display = 'block';
                chartContainer.style.position = 'relative';
                chartContainer.style.height = '400px';
                chartContainer.style.width = '100%';
            }
            
            // Ensure canvas has proper dimensions
            chartEl.style.width = '100%';
            chartEl.style.height = '100%';
            
            // Force layout recalculation
            void chartEl.offsetHeight;
            
            // Destroy existing chart if it exists
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
                categoryChartInstance = null;
            }
            
            // Wait for layout to complete and Chart.js to be ready
            requestAnimationFrame(() => {
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not available');
                    chartEl.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Chart.js library not loaded</p>';
                    return;
                }
                
                const ctx = chartEl.getContext('2d');
                if (!ctx) {
                    console.error('Could not get canvas context');
                    return;
                }
                
                const categories = ['Hollywood', 'Bollywood', 'Tollywood'];
                const data = categories.map(cat => {
                    return top10Movies
                        .filter(m => m.category === cat)
                        .reduce((sum, m) => sum + getGrossAmount(m, currentCurrency), 0);
                });
                
                console.log('Creating category chart with data:', data);
                console.log('Canvas dimensions:', chartEl.offsetWidth, chartEl.offsetHeight);
                
                try {
                    categoryChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: categories,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(255, 107, 107, 0.8)',
                                'rgba(74, 222, 128, 0.8)'
                            ],
                            borderColor: [
                                'rgba(102, 126, 234, 1)',
                                'rgba(255, 107, 107, 1)',
                                'rgba(74, 222, 128, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    color: 'var(--text)',
                                    font: {
                                        size: 12
                                    },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const total = data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        if (currentCurrency === 'USD') {
                                            return context.label + ': $' + (value / 1000000000).toFixed(2) + 'B (' + percentage + '%)';
                                        }
                                        return context.label + ': ‚Çπ' + (value / 10000000000).toFixed(2) + 'Cr (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                    });
                    console.log('Category chart created successfully');
                } catch (error) {
                    console.error('Error creating category chart:', error);
                    chartEl.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Error loading chart: ' + error.message + '</p>';
                }
            });
        }

        // Listen for currency changes
        window.addEventListener('currencyChanged', () => {
            currentCurrency = getCurrency();
            displayLeaderboard();
            loadTop10Chart();
            loadCategoryChart();
        });

        // Check if Chart.js is loaded
        function checkChartJS() {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded!');
                return false;
            }
            return true;
        }

        // Initialize currency toggle and load data
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Top 10 page DOM loaded');
            
            // Check Chart.js availability
            if (!checkChartJS()) {
                console.error('Chart.js library not found. Please ensure it is loaded.');
                const chartCards = document.querySelectorAll('.chart-card');
                chartCards.forEach(card => {
                    const canvas = card.querySelector('canvas');
                    if (canvas) {
                        canvas.parentElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">Chart.js library not loaded</p>';
                    }
                });
            }
            
            // Setup currency toggle
            const currencyBtns = document.querySelectorAll('.currency-btn');
            const currentCurrencyPref = getCurrency();
            
            currencyBtns.forEach(btn => {
                if (btn.dataset.currency === currentCurrencyPref) {
                    btn.classList.add('active');
                }
                
                btn.addEventListener('click', () => {
                    const currency = btn.dataset.currency;
                    setCurrency(currency);
                    currencyBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCurrency = currency;
                    displayLeaderboard();
                    
                    // Reload charts after currency change
                    if (checkChartJS()) {
                        setTimeout(() => {
                            loadTop10Chart();
                            loadCategoryChart();
                        }, 100);
                    }
                });
            });
            
            // Load top 10 movies
            loadTop10();
        });
        
        // Also try immediately in case DOM is already loaded
        if (document.readyState === 'loading') {
            // DOM is still loading, wait for DOMContentLoaded
        } else {
            // DOM is already loaded
            console.log('DOM already loaded, initializing immediately...');
            if (checkChartJS()) {
                loadTop10();
            }
        }
    </script>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top" class="scroll-to-top" title="Scroll to top">‚Üë</button>
</body>
</html>
